# Specifies the version of the Docker Compose file format
version: "3.9"

services:
  # --- Backend Service ---
  server:
    # Custom name for the running container
    container_name: express-server
    # Look for a Dockerfile in the ./server directory to build the image
    build: ./server
    # Restart the container automatically if it crashes or the server reboots
    restart: always
    # Map the host's port 4000 to the container's port 4000
    ports:
      - "4000:4000"
    # Connect this container to the internal network
    networks:
      - fullstask-net

  # --- Frontend Service ---
  client:
    # Look for a Dockerfile in the ./client directory to build the image
    build:
      context: ./client
      args:
        # Pass the server URL here - using HTTPS domain for secure connection
        - VITE_API_URL=https://docker.devder.site/api
    # Custom name for the running container
    container_name: react-client
    # Restart the container automatically if it crashes or the server reboots
    restart: always
    # Connect this container to the internal network
    networks:
      - fullstask-net
    # Map the host's port 8080 to the container's port 80 (standard HTTP port)
    ports:
      - "8080:80"
    # Ensures the server starts before the client container is launched
    depends_on:
      - server

  # --- Reverse Proxy (SSL/HTTPS Handler) ---
  nginx:
    # Use the official Nginx image
    image: nginx:latest
    # Custom name for the running container
    container_name: nginx-proxy
    # Restart the container automatically if it crashes or the server reboots
    restart: always
    # Open port 80 (HTTP) and 443 (HTTPS) to the world
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Mount the Let's Encrypt certificates from the host to the container
      - /etc/letsencrypt:/etc/letsencrypt:ro
      # Mount the Nginx configuration file
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    # Connect to the same network as client and server
    networks:
      - fullstask-net
    # Ensure client and server are ready before Nginx starts
    depends_on:
      - client
      - server

# --- Network Configuration ---
networks:
  # Define a custom bridge network for inter-container communication
  fullstask-net:
    # Use the bridge driver, which is the standard for standalone containers
    driver: "bridge"